# ウェブアクセラレーターを操作する

ウェブアクセラレーターは、さくらインターネットが提供するCDNサービスで、
大阪および石狩に配置されたエッジサーバーを経由した任意のオリジンからのコンテンツ配信が可能です。
特定のドメイン名に対応するエッジサーバーのインスタンスのことを、ウェブアクセラレーターの用語では「サイト」と呼びます。

`SaVAC`はウェブアクセラレーターの操作についてのフルサポートを提供します。
これは、ウェブアクセラレーターの公開APIを通じた操作について、あらゆるパラメーターの組み合わせを可能とすることを意味します。

> [!WARNING] 
> この機能は[Tier 2 サポート](/POLICY.md)の対象です。
> 一部の引数の組み合わせでは不具合が発生したり、不十分なエラーメッセージしか示されなかったりする場合があります。
> 問題点を見つけた場合には、[イシュー](https://github.com/g1eng/savac/issues)でご連絡ください。


### 1. サイトの作成

新規のサイトを作成するには次のように実行します。

```shell
savac wa create \
  --domain-type own_domain \
  --domain new-site.example.com \
  --origin 192.0.2.1 \
  --host-header first-origin.example.com \
  your-new-site
```

> この例を実際に実行すると失敗します。
> あなたは`--origin`の引数として実在するIPアドレスないしはホスト名を指定する必要があり、
> あなたが管理するドメイン名を`--domain`の引数として渡す必要があります。

> [!NOTE]
> サイトは作成直後には無効化されています。

### 2. サイト一覧表示・サイト詳細の確認

`SaVAC`でウェブアクセラレーターのサイト一覧を表示するには次のように実行します。 

```shell
savac wa list
```

なお、サイト一覧情報では、サイト全体ワンタイムシークレットおよびオリジンガードトークンの値が返却されません。
これらの設定値を確認するためには、次のようにしてサイト詳細情報を確認する必要があります。

```shell
savac wa read your-new-site
savac wa read 12384671
```

### 3. サイトの有効化・無効化

サイトを有効化することにより、CDNエッジがHTTP/HTTPSアクセスを処理できるようになります。
なお、独自ドメインを指定したサイトを作成した場合、事前に適切な`CNAME`レコードもしくは`TXT`レコードが設定されていないと、サイトの有効化に失敗します。
適切なDNS設定が実施済みであれば、次のようにしてサイトを有効化できます。

```shell
savac wa enable your-new-site
```

メンテナンスなどでサイトを無効化する場合は、次のように実行します。

```shell
savac wa disable your-new-site
```

### 4. サイトの更新

新規に作成したサイトの構成を変更することを考えてみましょう。
ここでは、オリジンが別のホストに移転する場合を想定し、オリジンとHostヘッダ、オリジンへのリクエストプロトコルを変更してみます。

```shell
savac wa update \
  --origin-protocol https \
  --origin a-new-paas-for-origin-hosting.example.jp \
  --host-header second-origin.example.com \
  your-new-site
```

> この例では、`your-new-site`というサイトがすでに作成されていることを前提としています。
> あなたが、`1`でこのサイトを作成していない場合、実在するサイト名またはサイトIDを引数として与えてください。

さらに進んだケースとして、作成済みサイトのオリジンをS3バケットに変更する場合を想定してみます。
「さくらのオブジェクトストレージ」のS3互換バケットをオリジンとして設定する場合、以下のように実行すればよいでしょう。
(この例を実行するには、実際のバケット名とアクセスキーID、シークレットアクセスキーを用いる必要があります。)

```shell
savac wa update \
  --origin-type bucket \
  --endpoint https://s3.isk01.sakurastorage.jp \
  --region jp-north-1 \
  --bucket-name sample-bucket-name \
  --access-key SAMPLEACCESSKEYABCDEF102936 \
  --access-secret SAMPLESECRETACCESSSKEY1234567789090396790ABCDEF102936 
```

> [!NOTE] 
> この実行例では、アクセスキーなどの認証情報がコマンド履歴に記録される可能性があります。
> 実際の運用では、環境変数を用いて平文の認証情報を入力しないようにしたり、実行後にコマンド履歴を消去したりする必要があるでしょう。

### 5. サイトの削除

サイトを閉鎖する場合には[サイトを無効化](#3-サイトの有効化無効化)した上で、次のように実行します。

```shell
savac wa delete your-new-site
```
