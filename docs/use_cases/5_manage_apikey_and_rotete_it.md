# 5. APIキーとロールを管理する

SaVACはAPIキーを使ってVPS APIにアクセスします。
VPS APIキーには比較的細やかな権限を設定できますので、毎日使うAPIキーには作業に必要な最小の権限を付与しておくようにしましょう。

ここでは、APIキーの安全な管理方法とローテーションの仕方について紹介します。

## 5.1. APIキーのライフサイクルについて

VPS APIを日常的に使っているとすれば、あなたは大切なシステムを「さくらのVPS」に設置しているか、SaVACのヘビーユーザーであることでしょう。
いずれにしても、APIキーを利用してVPS APIにアクセスする以上は、その権限モデルを十分に理解した上で安全な運用を心がけたいものです。
新規発行する場合には最小権限のみを付与したAPIキーを発行し、使わないAPIキーは廃止し、万が一APIキーが漏洩したときには鍵の削除やローテーションが必要となるでしょう。

VPS API の権限モデルの概要については[認証情報についての解説](../CREDENTIALS.md#さくらのvps-apiの認証情報)でも触れていますが、
詳細については[公式マニュアルの記事](https://manual.sakura.ad.jp/vps/api)を参考にしてください。

あるプロジェクトにおけるスタッフ毎のAPIキーの使用状況を例に、適切なAPIキーの取り扱いについて考えてみましょう。

## 5.2. ケーススタディ: プロジェクトライフサイクルに応じた適切なAPIキー管理を考える


```
[project A]
       staff-P ---> APIキー取得(4/12) ---> (使用中) --> ...
       staff-Q ---> APIキー取得(4/12) ---> (使用中) --> 他のプロジェクトへ異動・専任 (8/13)
                           staff-R ---> APIキー取得(6/15) ---> (使用中) --> ...
       staff-S ---> APIキー取得(4/13) ---> (使用中) --> APIキーを含むコミットをGithubに送信 (8/21)
       staff-T ---> APIキー取得(4/12) ---> (使用中) --> 長期休業 (7/31)
```

このプロジェクトは4人体制でSaaSプロダクトの開発を進めており、「さくらのVPS」がプロダクトのデプロイ先の１つとなっています。
主任`P`以外については開発用VPS (host1,host2,host3) の起動・停止のみができるAPIキーを配布しており、
主任のAPIキーはこれに加えてNICの接続先変更とNFSの電源操作,APIキーに紐付いた権限の表示を行うことができます。

APIキーの発行や削除を含む権限操作はVPSコントロールパネルのみで実施しており、権限操作のできるAPIキーは発行していません。

上の図からは、次のような事柄を推察できます。

* スタッフの異動や休職が生じています。こうした人事異動があった場合、特定のプロジェクトメンバーに割り当てたAPIキーは一旦削除して良いでしょう。
* 途中で加わったスタッフのAPIキーの権限は正しく設定されていますか？発行担当者が過剰な権限を付与していないかどうかを確認しておきましょう。
* 開発者`S`がGitHubにAPIキーを含むコードをpushしてしまいました。幸いにも非公開リポジトリでしたが、APIキーは変更する必要があるでしょう。

※ この例ではAPIキーの削除やローテーションが必要なタイミングが３カ所あります。

## 5.3. HowTos

### (1) APIキーを発行・削除する

この例では、APIキーの発行や削除はコントロールパネルで実施していました。
これは、VPS APIの現時点の仕様(v5.0.0)におけるベストプラクティスであり、中小規模のプロジェクトで推奨されるAPIキーの管理方法です。

ごく稀ではありますが、もしあなたのプロジェクトが大規模だったり、社外のエンジニアに対してAPIキーの引き渡しを実施している場合には、
APIキーの発行・削除・ローテーションの全てをAPI経由で実施したい場合があるかも知れません。

こうした場合には、次のようにしてAPIキーを発行したり、削除したりすることができます。

```shell
savac apikey create --role 3817 sample-api-key
savac apikey delete another-api-key
```

> [!IMPORTANT]
> APIキーにAPIキーの作成権限を持たせることは、一般的なプロジェクトでは非推奨です。
> APIキーの発行権限があるAPIキーは、発行するAPIキーに任意の権限を紐付けることができます。
> これは、事実上、任意の人物に管理者レベルのAPI利用権限を与えることができることを意味しており、発行されたAPIキーの権限を制限することができなくなる場合があります。

### (2) APIキーを再発行する

APIキーを誤って公開してしまったり、不慮の事故でAPIキーが漏洩した可能性があるときには、APIキーのローテーション(ないしは削除)を実施する必要があります。既存の鍵を失効させ、新たな鍵を発行することで、漏洩した鍵を悪用されるリスクを軽減することができます。なお、APIキー操作はリソース単位での権限を設定できないため、ローテーション操作は管理者のみが実施できるようにしておく必要があります。

```shell
savac apikey rotate my-key-id
```

> APIキーのローテーション権限があれば、APIキーIDが既知の任意の鍵を失効させ、正規の権限が付与された新しい鍵を取得できます。
> この権限が不要である場合は、APIキーの作成やローテーションをコントロールパネルから実施することをお勧めします。

### (3) 新しいロールを定義する

特別な仕事をするためには、特別なロールが必要となる場合があります。ここではsavacを使って新しいロールを定義する方法を説明します。

ロールは権限の束として定義されるものであるため、ロール作成時には紐付ける権限の一覧を`--perm`オプションで指定する必要があります。
権限には事前定義済みの権限コード(`code`)があるため、まず、権限一覧の中からあなたが必要とする権限コードを選び出す必要があります。

savacでは、次のコマンドで事前定義済みの権限一覧を取得することができます。

```shell
savac perm
```

たとえば、スイッチに関する操作権限をのみを付与したロールを作成するには、次のように権限カテゴリを指定します。

```shell
savac role create --perm switch new-switch-role
```

特定のスイッチグループに対する権限のみを付与したい場合は、スイッチの名前と部分一致するリソースを絞り込む事ができます。
`--perm`オプションを指定しないことに注意してください。

```shell
savac role create --resource proj-x- new-switch-role-2
```

特定のサーバーに対する操作権限のみを付与したい場合には、`--resource`の引数としてサーバーIDを指定することよいでしょう。

```shell
savac server start --resource 1728751 single-server-role-1
```


サーバーとNFSの起動・停止・再起動のみを許可するロールを作成する場合には、次のようにするとよいでしょう。
`--perm`オプションは正規表現にマッチする名前をもつ全ての権限を新しいロールに紐付けることができます。

```shell
savac role create --perm "post-(nfs-)?server-(power-on|shutdown|force-reboot)" your-role-name
```


