


# SaVAC の取り扱う認証情報

SaVACでは、利用するサービスの種類によって異なる認証情報を利用します。
これらの認証情報は全てを指定する必要はありませんが、利用したいサービスに対してアクセス権限のある認証情報を設定しておく必要があります。

この記事では、SaVACの取り扱う認証情報の種類とスコープ、設定方法について説明します。

## さくらインターネットにおける認証情報の種類

さくらインターネットにはAPIを通じたサービスアクセスを提供するための認証情報が複数存在します。認証情報の種類と設定される権限の一覧は以下の通りです。

| 権限種別            | VPS | IaaS | Payment | Container | CDN | OBJS |
|-----------------|-----|------|---------|-----------|-----|------|
| VPSアクセスキー       | 📙  | ❌    | ❌       | ❌         | ❌   | ❌    |
| *管理者            | ❌   | ✅+   | ✅       | ✅         | ✅   | 🌓   |
| *設定編集           | ❌   | ⚙️+  | ⚙️      | ⚙️        | ⚙️  | ⚙️   |
| *閲覧者            | ❌   | 👀+  | 👀      | 👀        | 👀  | 👀   |
| *請求管理者          | ❌   | ❌    | ✅       | ❌         | ❌   | ❌    | 
| Site Access Key | ❌   | ❌    | ❌       | ❌         | ❌   | ✅    |
| Permission Key  | ❌   | ❌    | ❌       | ❌         | ❌   | 🔵   |

項目凡例

* 📙 リソース毎に細やかな権限設定が可能
* ✅ 特権アクセス
* 🌓 間接的な特権アクセス
* ⚙️ 作成済みリソースの操作権限
* 👀 閲覧権限
* 🔵 バケットごとの`RW`/`RO`/`WO`権限のみ設定可能
* ❌ アクセス不可

> [!NOTE]
> * `*`がついている権限種別は、「さくらのクラウド」サービスのユーザー権限/アクセスキー権限として実装されています。
> * `+`がついている項目は取り消し不能な権限を表します。この権限を取り消すには、ユーザーないしはアクセスキーを削除する必要があります。

## SaVACにおける各種認証情報の設定方法

SaVACは環境変数またはファイルによる認証情報の設定が可能です。コマンド起動時にSaVACが参照する環境変数およびファイルの一覧は、以下の通りです。

| 環境変数名                             | 対象             | 参照ファイル                                |
|-----------------------------------|----------------|---------------------------------------|
| `SAKURA_VPS_API_SECRET`           | VPS API アクセスキー | なし                                    |
| `SAKURACLOUD_ACCESS_TOKEN`        | クラウドAPI        | ~/.usacloud/config                    |
| `SAKURACLOUD_ACCESS_TOKEN_SECRET` | クラウドAPI        | ~/.usacloud/config                    |
| `SAKURASTORAGE_ACCESS_KEY`        | オブジェクトストレージ    | ~/.aws/config<br/> ~/.aws/credentials |
| `SAKURASTORAGE_ACCESS_SECRET`     | オブジェクトストレージ    | ~/.aws/config<br/> ~/.aws/credentials |

* 環境変数と設定ファイルの双方が存在する場合、環境変数の値が優先適用されます


# 各認証情報の詳細と留意点について

## さくらのVPS APIの認証情報

さくらのVPS APIのアクセスキーは、1件以上のVPS契約が存在する場合にのみ発行できます。

個別のAPI鍵に対しては<ruby>役割<rt>ROLE</rt></ruby>が紐付けられます。
<ruby>役割<rt>ROLE</rt></ruby>ごとに適切な<ruby>権限<rt>PERMISSION</rt></ruby>を付与することで、
業務上のルールと役割に基づいたアクセス制御(RBAC)を実現できます。

権限の指定の仕方は以下の4種類です。

1. 全操作を許可
2. 特定操作のみ許可
3. 特定リソースの操作のみ許可
4. 特定リソースもしくは特定操作を指定して許可

※ 2025年7月現在、VPS APIロール定義では「リソース」と「操作」をキーとするAND条件を指定できません。

APIキーには有効期限を設定することができません。鍵に過剰な権限を付与したり、利用しない鍵を削除せずに放置したりすることは避けましょう。
特に、APIキーの発行権限やロールの変更権限を付与した鍵が窃取された場合には、不正な特権キーを際限なく発行することが可能になります。

APIキーは削除や<ruby>再発行<rt>ROTATION</rt></ruby>が可能であり、SaVACもこれらの操作のためのコマンドを実装しています。

```shell
savac api-key rotate your-api-key-id
savac api-key delete your-another-api-key-id
```

> [!IMPORTANT]
> APIキーが危殆化した可能性が疑われる場合には、こうした機能を活用して緊急のオペレーションを実施することができるでしょう。
> また、万が一の場合に備えて、緊急操作のための作業手順や通常業務用の鍵のロール権限についても、事前に十分な検討をしておくと良いでしょう。

なお、VPS APIのアクセストークンは、他のサービスに対するアクセスは一切許可されていません。さくらインターネットの様々なサービスを利用したい場合は、「さくらのクラウド」のアクセストークンを発行する必要があります。


## さくらのクラウドAPIの認証情報について

DNSやコンテナレジストリ、高火力DOK、オブジェクトストレージなどの「さくらのクラウド」関連リソースを操作する場合は、
さくらのクラウドのAPIキー(アクセストークンとアクセストークンシークレットの組)を作成する必要があります。

クラウド認証情報については、環境変数`SAKURACLOUD_ACCESS_TOKEN`および`SAKURACLOUD_ACCESS_TOKEN_SECRET`として設定することができます。また、`usacloud`互換の標準設定ファイルとして事前に設置しておくことで、環境変数が設定されない場合でも認証情報を読み取ることが可能です。

これらの認証情報の詳細については[usacloudのドキュメント](https://github.com/sacloud/usacloud)を参照してください。

## オブジェクトストレージの認証情報について

さくらのクラウドのオブジェクトストレージ関連機能を利用する場合は、オブジェクトストレージに限定したアクセス権限を持つ
<ruby>**サイトアクセスキー**<rt>　       SITE ACCESS KEY      　</rt></ruby> や <ruby>**権限キー**<rt>PERMISSION KEY</rt></ruby>
を利用することができます。

また、「作成・削除」のあるさくらのクラウドAPIキーに対して、オブジェクトストレージへのアクセス権限を付与している場合、オブジェクトの操作を除くサービス全体の操作が許可されます。

> [!WARNING]
> オブジェクトストレージへの操作権限を有する「さくらのクラウドAPI」のアクセストークンを使用する場合、
> <u>**オブジェクトストレージのサイトアクセスキーの発行・削除やバケットの作成・削除といった**</u>、
> 間接的な特権操作が可能となります。
> 
> このことは運用中のバケットやコンテンツの管理に予期せぬリスクをもたらす可能性がありますので、慎重に検討してください。


オブジェクトストレージに関する操作の詳細については[SaVACのオブジェクトストレージ操作機能のドキュメンテーション](https://g1eng.github.io/SaVAC/docs/advanced_use_cases/object_storage)を参照してください。

オブジェクトストレージ内部にアクセスする場合には、サイトアクセスキーまたは権限キーの作成が必要です。
SaVACでは、オブジェクトストレージのアクセスキーとアクセスシークレットを`SAKURASTORAGE_ACCESS_KEY`および`SAKURASTORAGE_ACCESS_SECRET`として指定できます。

これらの環境変数を指定しない場合には、AWS CLIを用いて作成した設定ファイル (`~/.aws/config`および`~/.aws.credentials`)からの認証情報の読み込みを試みます。
SaVACは、デフォルトで`sakurastorage`という名前のプロフィールの読み込みを試行し、このプロフィールが設定ファイルに存在しない場合には、オブジェクトストレージの認証情報が設定されません。

AWS CLI を通じて認証情報の設定を実施した場合には、設定ファイルに次のような記述がなされていることを確認してください。


```~/.aws/config
# In ~/.aws/config

[profile sakurastorage]
region = jp-north-1
output = json
aws_endpoint_url = https://s3.isk01.sakurastorage.jp
s3_use_sigv4 = true
```

```~/.aws/credentials
# In ~/.aws/credentials

[sakurastorage]
aws_access_key_id = xxxxxxxxxxxxxxxxxxxx
aws_secret_access_key = xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```
